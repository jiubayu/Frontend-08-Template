<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<style>
    .chess-pieces{
        width: 100px;
        height: 100px;
        border: 1px solid;
        background: darkblue;
        /* BFC-> IFC */
        display: inline-block; 
        margin:0 8px 8px 0;
        font-size: 60px;
        text-align: center;
        /* IFCé»˜è®¤å¯¹é½æ–¹å¼base-line? */
        vertical-align: middle;
    }
</style>
<body>
    <div id="board"></div>
</body>
<script>
    // AI
    // ç­–ç•¥åˆ†å±‚ï¼š ç¬¬ä¸€å±‚ => æˆ‘è¦èµ¢     ç¬¬ä¸€å±‚ => åˆ«è¾“     èµ°å®Œåï¼Œå¯¹æ–¹ä¸èƒ½èµ¢
    // preview: é¢„æµ‹è¾“èµ¢
    // åšå¼ˆè®ºï¼Ÿ æˆ‘ä»¬æœ€å¥½çš„ç­–ç•¥æ˜¯å¯¹æ–¹æœ€åçš„ç­–ç•¥ï¼Œå³æˆ‘èµ¢å¯¹æ‰‹å°±è¾“

    // æ•°æ®
    let data = [
        [0, 0, 0],
        [0, 0, 0],
        [0, 0, 0]
    ]
    // æ•°æ®åŒæ ·å¯ä»¥ç”¨ä¸€ä½æ•°ç»„è¿›è¡Œè¡¨ç¤º
    // é‚£ä¹ˆæ‰€æœ‰å¯¹åº”çš„å¾ªç¯éƒ½éœ€è¦ç”¨3*i+jæ¥è¿›è¡Œä½ç½®çš„è¡¨ç¤º
    // @todo:äº”å­æ£‹å¯ä»¥å°è£…åç”¨ä¸€ä½æ•°ç»„è¿›è¡Œå¤„ç†
    let pattern = [
        0, 0, 0,
        0, 0, 0,
        0, 0, 0
    ]

    let board = document.getElementById('board')
    // â­•: 1 â­•å…ˆ
    let currCHessPlayer = 1
    // let anotherplayer = 2/currCHessPlayer
    // ç»˜åˆ¶æ£‹ç›˜
    function show(data){
        // createDocumentFragementå‡å°‘é‡æ’
        // åˆ›å»ºä¹‹å‰å…ˆæ¸…ç©º
        board.innerHTML = ''
        let fragment = document.createDocumentFragment();
        // ä¸¤å±‚éå†
        for(let i=0;i<data.length;i++){
            for(let j=0;j<data[i].length;j++){
                let cell = document.createElement('div')
                cell.classList.add('chess-pieces')
                cell.addEventListener('click', function (e) {
                    userChess(i,j)
                }) 
                // innerHTMlå¯èƒ½ä¼šå‡ºç°XSSæ”»å‡»çš„é—®é¢˜ï¼Œæ…ç”¨
                cell.innerText = data[i][j] === 1 ? 'â­•' :
                                 data[i][j] === 2 ? 'âŒ' : null             
                fragment.appendChild(cell)                    
            }
            let br = document.createElement('br')
            fragment.appendChild(br)
        }
        board.appendChild(fragment)
    }

    show(data)

    // è½å­: å½“å‰æ£‹æ‰‹ ä½ç½®
    // function actionChess(x,y){
    function userChess(x, y) {
        // console.log(x,y, 'pos');
        // è½å­å†…å®¹
        data[x][y] = currCHessPlayer
        // å¦‚æœæ£‹æ‰‹è·å–ï¼Œåˆ™æ˜¾ç¤ºè·èƒœä¿¡æ¯
        if(checkWin(data, currCHessPlayer)){
            alert(currCHessPlayer === 1 ? 'â­• is winner' : 'âŒ is winner')
        }
        // æ£‹æ‰‹è½®æ¢
        // 1 3-2=1  2 2/1=2  
        currCHessPlayer = 2/currCHessPlayer
        console.log(bestChoice(data, currCHessPlayer));

        // showé‡Œé¢å¼•ç”¨actionChess,actionChesså¼•ç”¨showï¼Œä¹‹æ‰€ä»¥æœ‰å‡ºå£ï¼Œæ˜¯å› ä¸ºdataæ˜¯å…¨å±€å˜é‡ï¼Ÿ
        show(data)

        // åˆæ­¥AIï¼šå¯ä»¥é¢„çŸ¥æ¯”èµ›èƒœè´Ÿ
        if(previewWin(data, currCHessPlayer)){
            console.log(currCHessPlayer === 1 ? 'â­• is winner' : 'âŒ is winner')
        }

        // ç”µè„‘è½å­
        computerChess()
    }

    // ç”µè„‘è½å­
    function computerChess(){
        let choice = bestChoice(data, currCHessPlayer)
        if(choice.point)
            data[choice.point[1]][choice.point[0]] = currCHessPlayer

        if(checkWin(data, currCHessPlayer))
            alert(currCHessPlayer === 1 ? 'â­• is winner' : 'âŒ is winner')
        
        currCHessPlayer = 2/currCHessPlayer
        show(data)    
    }

    function deepClone(data){
        return JSON.parse(JSON.stringify(data))
    }
    // previewé¢„æµ‹: å’ŒcheckWinåŒºåˆ«ï¼Œä¸ç”¨éå†éç©ºä½ç½®ï¼Œç›¸ä¼¼å¤„ï¼šå…¶å®å°±æ˜¯å¤šæƒ³ä¸€æ­¥ï¼Œç”¨æ¨¡æ‹Ÿåçš„æ£‹å±€è°ƒç”¨checkWinå‡½æ•°
    
    function previewWin(pattern, player){
        for(let i=0;i<pattern.length;i++){
            for(let j=0;j<pattern[i].length;j++){
                if(pattern[i][j])
                    // return åº”è¯¥ç”¨continueï¼š continueï¼šè·³å‡ºæœ¬æ¬¡å¾ªç¯ï¼Œä»ä¸‹ä¸€ä¸ªå¾ªç¯ç»§ç»­è¿è¡Œå¾ªç¯
                    // return ç›´æ¥è¿”å›å‡½æ•°ï¼Œæ‰€æœ‰è¯¥å‡½æ•°ä½“å†…çš„ä»£ç (åŒ…æ‹¬å¾ªç¯ä½“)éƒ½ä¸ä¼šå†æ‰§è¡Œ
                    continue
                let temp = deepClone(pattern)
                temp[i][j] = player
                if(checkWin(temp, player)){
                    // return true
                    // ä¸ºbestChoiceåšçš„æ›´æ”¹
                    return [j, i]
                }

            }
        }
        // return false
        return null
    }

    // æ‰¾ç•™ç»™å¯¹é¢æœ€å·®å±€é¢çš„ç‚¹çš„ä½ç½®çš„è¿™æ ·çš„ä¸€ä¸ªå‡½æ•°
    // èƒœè´Ÿå‰ªæï¼š å¯¹äºåªæœ‰èƒœè´Ÿçš„æ¸¸æˆï¼Œæ‰¾åˆ°èƒœåˆ©çš„è½å­ä½ç½®å°±å¯ä»¥ç»ˆæ­¢ï¼Œè€Œå¦‚å›´æ£‹éœ€è¦è€ƒè™‘èƒœåˆ©çš„æœ€å¤§å€¼(å¤šå°‘æ‰‹)
    // äº†è§£ï¼šç¥ç»ç½‘ï¼Œä¼°å€¼
    function bestChoice(pattern, player){
        let p
        // $å°æŠ€å·§ ifåˆ¤æ–­çš„åŒæ—¶å¯ä»¥è¿›è¡Œèµ‹å€¼æ“ä½œ på¤åˆ¶ä¸º[j,i]
        // ç‰¹ä¾‹ï¼Œå¦‚æœå·²ç»å¯ä»¥é¢„æµ‹å¯¹æ–¹èµ¢ï¼Œåˆ™å¯ä»¥ç›´æ¥è¿”å›è½å­ä½ç½®å’Œç»“æœ1win -1fail 0 å’Œ
        if(p = previewWin(pattern, player)){
            return {
                point: p,
                result: 1 // èµ¢1 è¾“-1 0å’Œ
            }
        }

        let result = -2 // åˆå§‹å€¼ æœ€å·®ä¸º-1
        let point = null
        outer: for(let i=0;i<pattern.length;i++){
            for(let j=0;j<pattern[i].length;j++){
                if(pattern[i][j])
                    continue // è·³è¿‡éç©ºä½ç½®
                let temp = deepClone(pattern)
                temp[i][j] = player
                let oop = bestChoice(temp, 2/player)
                // åšå¼ˆè®º: æˆ‘èµ¢ == å¯¹æ‰‹è¾“å³ æˆ‘1 == å¯¹æ‰‹-1
                // æˆ‘ä»¬èµ°å®Œç•™ç»™å¯¹æ–¹æœ€å·®çš„å±€é¢æ˜¯-rï¼Œå¯¹æ‰‹çš„å±€é¢æ˜¯1ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´å°±æ˜¯-1ï¼Œä¹Ÿå°±æ˜¯-r
                // console.log(r, result, -r>result);
                if(-oop.result > result){
                    result = -oop.result
                    point = [j, i]
                }  
                // èƒœè´Ÿå‰ªæ 
                // å°æŠ€å·§ $ ä¸­æ–­åµŒå¥—å¾ªç¯ï¼Œå°†æœ€å¤–å±‚çš„å¾ªç¯å‘½ä»¤ï¼Œåˆ©ç”¨breaké€€å‡ºæ•´ä¸ªå¾ªç¯ä½“ 
                if(result === 1){
                    break outer
                }  
            }
        }
        // console.log(point, result);
        return {
            point: point,
            result: point ? result : 0
        }
    }

    // èµ¢è§„åˆ™ï¼šä¸‰çºµä¸‰æ¨ª ä¸¤äº¤å‰ 
    // ä¸‰æ¨ª åŒä¸€æ’(iç›¸åŒ) ä¸‰çºµ åŒä¸€åˆ—(jç›¸åŒ)
    // å·¦ä¸Š-å³ä¸‹äº¤å‰(i,jç›¸åŒ) å¦ä¸€ä¸ª(i+j=2)
    // ä¼ å‚æ•°éœ€è¦å½“å‰æ£‹ç›˜å’Œå½“å‰æ£‹æ‰‹
    function checkWin(pattern, player){
        // è½å­ä¸ºâ­•ï¼Œåˆ™åªéœ€è¦åˆ¤æ–­æ‰€æœ‰â­•æ˜¯å¦ç¬¦åˆè¿™ä¸€è§„åˆ™
        // $å°æŠ€å·§ï¼š {}ä¹‹å†…å¯ä»¥ç®—ä½œä¸€ä¸ªä½œç”¨åŸŸï¼Œletå£°æ˜çš„å˜é‡åªåœ¨ä½œç”¨åŸŸå†…ç”Ÿæ•ˆ
        // ğŸ™†â€â™‚åŒä¸€è¡Œ
        {
            for(let i=0;i<pattern.length;i++){
                let win = true
                for(let j=0;j<pattern.length;j++){
                    if(data[i][j] !== player){
                        win = false
                    }
                }
                if (win)
                    return true
            }     
        }

        // åŒä¸€åˆ— 
        for(let i=0;i<pattern.length;i++){
            let win = true
            for(let j=0;j<pattern[i].length;j++){
                // å°æŠ€å·§ å…ˆæ‰“å°è¡Œï¼Œå†æ‰“å°åˆ—ç”¨data[i][j] å…ˆæ‰“å°åˆ—ï¼Œå†æ‰“å°è¡Œ
                if(pattern[j][i] !== player){
                    win = false
                }
            }
            if(win)
                return true
        }

        // å·¦ä¸Šåˆ°å³ä¸‹
        {
            let win = true
            // data[x].lengthæ¯”3è¦å¥½ï¼Ÿ
            for (let j = 0; j < pattern[0].length; j++) {
                // å°æŠ€å·§ å…ˆæ‰“å°è¡Œï¼Œå†æ‰“å°åˆ—ç”¨data[i][j] å…ˆæ‰“å°åˆ—ï¼Œå†æ‰“å°è¡Œç”¨data[j][i]
                if (pattern[j][j] !== player) {
                    win = false
                }
            }
            if (win)
                return true
        }
        // å¦ä¸€æ¡
        {
            let win = true
            for(let j=0;j< pattern[0].length;j++){
                if(pattern[j][2-j] !== player){
                    win = false
                }
            }
            if(win){
                return true
            }
        }
          
    }
</script>
</html>